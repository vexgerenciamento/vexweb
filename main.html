<!DOCTYPE html>
<html lang="pt-BR">

<head>
        <script>
            var user_final = localStorage.getItem('valueText');
            var nome = localStorage.getItem('nome');
            var senha = localStorage.getItem('senha');
            if((user_final== null) || (user_final=="")){
                window.location.href = 'pag_ini.html';
            } else if((senha==null) || (senha==null)){
                window.location.href = 'pag_ini.html';
            }
            else if((nome==null) || (nome==null) ){
                window.location.href = 'pag_ini.html';
            }
        </script>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Karla:ital,wght@0,400;0,700;1,200;1,800&display=swap"
        rel="stylesheet">
        <link rel="stylesheet" href="CSS/button.css">
        <link rel="stylesheet" href="CSS/main.css">
        <link rel="stylesheet" href="CSS/modal.css">
        <link rel="stylesheet" href="CSS/records.css">
        
    <title>CRUD</title>
</head>

<body>
    <header>
        <input id="searchbar" onkeyup="search_valor()" type="text" name="search" placeholder="PESQUISE" style="border-radius: 90px;padding: 10px;border: none;margin: 10px;width: 400px;">

            <span class="material-icons-outlined"></span>
    </header>
    
    <main>
        <button type="button" class="button blue mobile" id="cadastrarCliente">Cadastro de valores</button>

            <div class="container mt-3">
            
                <table id="tableClient" class="records">
                    <thead>
                        <th>id</th>
                        <th>Nome</th>
                        <th>Tipo</th>
                        <th>Valor</th>
                        <th>Período</th>
                        <th>Controle</th>
                    </thead>
                    <tbody id="tbody">

                    </tbody>
                </table>

            <div id="IdVerdadeiro">  </div>

            <div class="modal" id="modalCriar">
                <div class="modal-content">
                    <header class="modal-header">
                        <h2>Novo Valor</h2>
                        <span class="modal-close" id="modalCloseCriar">&#10006;</span>
                    </header>

                    <form id="form" class="modal-form">

                        <input type="text" id="id_compra" style="display: none;"></input>
                        <input type="text" id="nome" data-index="new" class="modal-field" placeholder="Nome"required>

                            <select id="tipo" name="tipo" class="modal-field">
                                <option value="" disabled selected hidden>Tipo</option>
                                <option value="educação">educação</option>
                                <option value="alimentação">alimentação</option>
                                <option value="lazer">lazer</option>
                                <option value="outros"> outros</option>
                            </select>

                        <input type="number" id="valor" class="modal-field" placeholder="Valor" required>

                        <select id="periodo" name="periodo" class="modal-field">

                            <option value="" disabled selected hidden>Tipo</option>
                            <option value="fixo">fixo</option>
                            <option value="esporadico">esporadico</option>

                        </select>
                    </form>

                    <footer class="modal-footer">
                        <button id="salvar" class="button green">Salvar</button>
                        <button id="cancelar" class="button blue">Cancelar</button>

                    </footer>
        
                </div>
            </div>



        <div class="modal" id="modalEditar" onload="selectData()">
            <div class="modal-content">
                <header class="modal-header">
                    <h2>EDITANDOOOOO</h2>
                    <span class="modal-close" id="modalCloseEditar">&#10006;</span>
                </header>
                <form id="form" class="modal-form">
                    <input type="text" id="nomeEditar" data-index="new" class="modal-field" placeholder="Nome"
                        required>
                        <select id="tipoEditar" name="tipo" class="modal-field">
                            <option value="" disabled selected hidden>Tipo</option>
                            <option value="educação">educação</option>
                            <option value="alimentação">alimentação</option>
                            <option value="lazer">lazer</option>
                            <option value="outros"> outros</option>
                        </select>
                    <input type="number" id="valorEditar" class="modal-field" placeholder="Valor" required>
                    <select id="periodoEditar" name="periodo" class="modal-field">
                        <option value="" disabled selected hidden>Tipo</option>
                        <option value="fixo">fixo</option>
                        <option value="esporadico">esporadico</option>
                    </select>
                </form>
                <footer class="modal-footer">
                    <button id="editar" class="button blue">Editar</button>
                </footer> 
            </div>
        </div>

        <div class="modal" id="modalDeletar">
            <div class="modal-content">
                <header class="modal-header">
                    <h2>DESEJA REALMENTE EXCLUIR?</h2>
                    <span class="modal-close" id="modalClose1">&#10006;</span>
                </header>
            
                <footer class="modal-footer">
                    <button id="excluir" class="button blue">EXCLUIR</button>
                </footer>
            </div>
        </div>
        


    </main>
    <footer>
        Copyright &copy; VEX-CRESÇA FINANCEIRAMENTE
    </footer>
    <script type="module">
        var user_final = localStorage.getItem('valueText');
        
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.8/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.6.8/firebase-analytics.js";

        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries
    
        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
        apiKey: "AIzaSyCd8BHepAbgzsZF0Ig8NRgsnTPRKvYkO4g",
        authDomain: "vexv1-adc55.firebaseapp.com",
        databaseURL: "https://vexv1-adc55-default-rtdb.firebaseio.com",
        projectId: "vexv1-adc55",
        storageBucket: "vexv1-adc55.appspot.com",
        messagingSenderId: "827882444760",
        appId: "1:827882444760:web:3b65498f6fe2161d1244ad",
        measurementId: "G-FBJX3WSQDX"
        };

        const firebaseApp = initializeApp(firebaseConfig);
    
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        import{getDatabase, ref, get, set, child, update, remove, onValue}
        from "https://www.gstatic.com/firebasejs/9.6.8/firebase-database.js";

        const db = getDatabase();

    function inputs(){
        var nome = document.getElementById("nome");
        var tipo = document.getElementById("tipo");
        var valor = document.getElementById("valor");
        var periodo = document.getElementById("periodo");
    }


var nomeMes = datas();
//---------------------------CRIAR DADOS---------------------------\\
const createClient = (client) => {
    
    var nomeMes = datas();
    inputs();
    var data = new Date();
    var segundos = data.getSeconds();
    var minutos = data.getMinutes();
    var horas = data.getHours();
    var dias =  data.getDate();
    var meses = data.getMonth()+1;
    var anos = String(data.getFullYear());

    var id = anos+meses+dias+'_'+horas+minutos+segundos;
    console.log(id);
    localStorage.setItem('db_client', client);
        set(ref(db, "users/"+user_final+"/"+nomeMes+"/gastos/"+id),
            {
                id: id,
                titutlo: document.getElementById("nome").value,
                tipo: tipo.value,
                valor: valor.value,
                periodo: periodo.value
            }
            )
            .then(()=>{

                document.getElementById('nome').value = null;
                document.getElementById('tipo').value = null;
                document.getElementById('periodo').value = null;
                document.getElementById('valor').value = null;
            
            })
            .catch((error)=>{

            })}

    
    document.getElementById("salvar").addEventListener('click', createClient);

   
//---------------------------LER E MOSTRAR DADOS---------------------------\\
var valores = [];      
var tbody = document.getElementById('tbody');

//-------------------RECEBENDO TODO O SNAPCHOT DO DB-------------------\\

function GetAllDataRT(){

const dbRef = ref(db,"users/"+user_final+"/"+nomeMes+"/gastos/");

    onValue(dbRef,(snapshot)=>{
    var gastos = [];
    snapshot.forEach(childSnapshot =>{
    gastos.push(childSnapshot.val());
    });
    AddAll(gastos);
    });
            }
    window.onload = GetAllDataRT;

//-------------------RECEBENDO DADOS DO SNAPCHOT-------------------\\

function AddAll(users){

    tbody.innerHTML="";
    users.forEach(element => {
        AddItemTb(element.id, element.titutlo,element.periodo, element.valor,element.tipo);
    });
}

//-------------------CRIANDO LINHAS DA TABELA-------------------\\
function AddItemTb(id, titutlo, periodo, valor, tipo){

    let trow = document.createElement('tr');
    let td1 = document.createElement('td');
    let td2 = document.createElement('td');
    let td4 = document.createElement('td');
    let td5 = document.createElement('td');
    let td6 = document.createElement('td');

    valores.push([id, titutlo, periodo, valor, tipo]);

    td1.innerHTML=id
    td2.innerHTML=titutlo;
    td4.innerHTML=periodo;
    td5.innerHTML=valor;
    td6.innerHTML=tipo;

    trow.appendChild(td1);
    trow.appendChild(td2);
    trow.appendChild(td4);
    trow.appendChild(td5);
    trow.appendChild(td6);  
    var Controle = document.createElement("div");
    var Editar = document.createElement("div");

    Controle.innerHTML = '<button type="button" class="btn btn-primary my-2" data-toggle="modal" id = "'+id+'"data-target="#exampleModalCenter" onclick="pegaId(id)" >Excluir</button>'
    Editar.innerHTML = '<button type="button" class="btn btn-primary my-2" data-toggle="modal" id = "'+id+'"data-target="#exampleModalCenter" onclick="pegaIdEditar(id);" >Editar</button>'

    trow.appendChild(Controle);
    trow.appendChild(Editar);
        
    tbody.appendChild(trow);                    

}


//---------------------------LER E MOSTRAR DADOS NOS MODAIS---------------------------\\

function selectData(){
    
var id = document.getElementById('idEditar').value;
console.log('carregou antes do tempo');

    const dbref = ref(db);
    get(child(dbref,"users/"+user_final+"/"+nomeMes+"/gastos/"+id)).then((snapshot)=>{
        if(snapshot.exists()){
            document.getElementById('nomeEditar').value = snapshot.val().titutlo;
            document.getElementById('tipoEditar').value = snapshot.val().tipo;
            document.getElementById('valorEditar').value = snapshot.val().valor;
            document.getElementById('periodoEditar').value = snapshot.val().periodo;
        }else{
          
        }
    })
    .catch((error)=>{
      
    });
}

document.getElementById('editar').addEventListener('click', selectData);


//---------------------------EXLUIR DADOS---------------------------\\
function deleteData(){
    var num = String(document.getElementById('teste').value).trim();
    
    console.log(num);
    remove(ref(db,"users/"+user_final+"/"+nomeMes+"/gastos/"+num),{
    })
    .then(()=>{

        closemodalDeletar();

    })
    .catch((error)=>{

    });
}

document.getElementById('excluir').addEventListener('click', deleteData);

export {createClient, deleteData ,AddAll, AddItemTb, GetAllDataRT, selectData, inputs}

    </script> 

<script>

//---------------------------PEGAR ID PARA EXCLUIR---------------------------\\
function pegaId(num){

        document.getElementById('IdVerdadeiro').innerHTML = `<input id="teste" value="${num}" hidden> </input>`;
        openmodalDeletar();
        return num;
    }
//---------------------------PEGAR ID PARA EDITAR---------------------------\\    
function pegaIdEditar(num){

        document.getElementById('IdVerdadeiro').innerHTML = `<input id="idEditar" value="${num}"> </input>`;
        openmodalEditar();
        return num;

}
//---------------------------POR EQUANTO---------------------------\\
//function search_valor() {
//        let input = document.getElementById('searchbar').value
//        input=input.toLowerCase();
//        let x = document.getElementsByClassName('valor');
//        let y = document.getElementsByClassName('nome');
//        let z = document.getElementsByClassName('tipo');
//       let a = document.getElementsByClassName('periodo');
//        let b = document.getElementsByClassName('op');
//        
//        for (i = 0; i < x.length; i++) { 
//            if ((!z[i].innerHTML.toLowerCase().includes(input)) && (!x[i].innerHTML.toLowerCase().includes(input))) {
//                x[i].style.display="none";
//                y[i].style.display="none";
//                z[i].style.display="none";
//                a[i].style.display="none";
//                b[i].style.display="none";
//            } 
//            else if (input === "") {
//                x[i].style.display="table-cell";
//                y[i].style.display="table-cell";
//                z[i].style.display="table-cell";
//                a[i].style.display="table-cell";
//                b[i].style.display="table-cell";
//            } 
//        }
//    }


//---------------------------MESES---------------------------\\


</script>
<script src="modais.js"></script>

</body>

</html>
