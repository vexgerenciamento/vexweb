<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Gráficos</title>
        <link rel="stylesheet" href="CSS/main2.css">
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
        <script src="autenticar.js"></script>
        <sscript src="logout.js"></sscript>
    </head>
    <style>
        .chart-wrapper{
            height: 43%;
            width: 43%;
            margin-left: 7%;
            padding-top: 3%;
        }

        .line-bar-chart-wrapper{
            display: flex;
        }

        .line-bar-chart-wrapper .line-chart {
            height: 30%;
            width: 40%;
            margin-right: 2%;
            border-radius: 2%;
        }

        .line-bar-chart-wrapper .bar-chart {
            height: 40%;
            width: 40%;
            margin-left: 2%;
            border-radius: 2%;
        }

        .doughnut-chart-wrapper {
            background-color: white;
            margin-top: 15%;
            border-radius: 2%;
            height: 100%;
            width: 100%;
            margin-left: 45%;
        }

        .doughnut-chart {
            height: 75%;
            width: 75%;
        }

    </style>
    <body bgcolor="#202020">

        <div class="inner body">
            <h1 class="ti tulo">
              <img src="img/vex dourado.png" style="width: 30px; height: 30px; position: relative;">
               VEX - Cresça Financeiramente</h1>
         </div>
        <div class="sc-kEjbQP fuVdYh">
            <div class="sc-iqHYmW jklSBJ setleft"><</div>
            <div class="sc-crrszt cPfwyB">Abril de 2022</div>
            <div class="sc-iqHYmW jklSBJ setright">></div>
        </div>
        <div class="sc-dQoVA klQxRK">
            <div class="sc-bqyKOL fXEhmA">
                <div class="sc-kstqJO bQkMyN">Ganhos</div>
                <div class="sc-hBEYId hZHyLH" id="ganhoInicial">R$00</div>
            </div>
            <div class="sc-bqyKOL fXEhmA">
                <div class="sc-kstqJO bQkMyN">Despesas</div>
                <div class="sc-hBEYId hZHyLH" style="color:rgb(255, 0, 0);" id="despesaInicial">R$00 </div>
            </div>
            <div class="sc-bqyKOL fXEhmA">
                <div class="sc-kstqJO bQkMyN">Balanço</div>
                <div color="green" class="sc-hBEYId ftQMvP" id="balanco">R$00 </div>
            </div>
        </div>
    </div>   
        
        <div class="chart-wrapper">
            <div class="line-bar-chart-wrapper">
                    <canvas class="line-chart" style="background-color: white;"></canvas>                    
                    <canvas class="bar-chart" style="background-color: white;"></canvas>      
                    <select class="selectBox" id="selectBoxBar" style="height: 25px;">
                        <option value="Alimentação">Alimentação</option>
                        <option value="Entretenimento">Entretenimento</option>
                        <option value="GastosPessoais">Gastos Pessoais</option>
                        <option value="Habitação">Habitação</option>
                        <option value="Salário">Salário</option>
                        <option value="Saúde">Saúde</option>
                        <option value="Seguros">Seguros</option>
                        <option value="Transportes">Transportes</option>                
                        <option value="Utilidades">Utilidades</option>
                        <option value="Outros">Outros</option>                        
                    </select>       
   
                </div>
                <button onclick="lineResetZoom()">Reset</button>
                <div class="doughnut-chart-wrapper">
                <select>
                    <option value="receita">Receita</option>
                    <option value="despesa">Despesa</option>
                </select>
        <canvas class="doughnut-chart"></canvas>
        </div>
        <br>
        
        </div>
        <section class="chart-tables" style="display: none;">
            <table class="crud chart-tables" >
                <thead>
                    <tr>
                        <th>Titulo</th>
                        <th>Valor</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>
        </section>
    </body>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/1.2.1/chartjs-plugin-zoom.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/1.2.1/chartjs-plugin-zoom.js"></script>
        <script type="module">
            const usuario = "teste";
            var user_final = localStorage.getItem('valueText');
            
            // Import the functions you need from the SDKs you need
            import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.8/firebase-app.js";
            import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.6.8/firebase-analytics.js";
    
            // TODO: Add SDKs for Firebase products that you want to use
            // https://firebase.google.com/docs/web/setup#available-libraries
          
            // Your web app's Firebase configuration
            // For Firebase JS SDK v7.20.0 and later, measurementId is optional
            const firebaseConfig = {
              apiKey: "AIzaSyCd8BHepAbgzsZF0Ig8NRgsnTPRKvYkO4g",
              authDomain: "vexv1-adc55.firebaseapp.com",
              databaseURL: "https://vexv1-adc55-default-rtdb.firebaseio.com",
              projectId: "vexv1-adc55",
              storageBucket: "vexv1-adc55.appspot.com",
              messagingSenderId: "827882444760",
              appId: "1:827882444760:web:3b65498f6fe2161d1244ad",
              measurementId: "G-FBJX3WSQDX"
            };

   
    
             const firebaseApp = initializeApp(firebaseConfig);
          
            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const analytics = getAnalytics(app);
            import{getDatabase, ref, get, set, child, update, remove, onValue}
            from "https://www.gstatic.com/firebasejs/9.6.8/firebase-database.js";
            const db = getDatabase();
        
        function datas(){
    var data = new Date();

    var mes = String(data.getMonth() + 1);

switch(mes){
    case '1':
        nomeMes = "jan"; 
        return nomeMes;
    break;
    case '2':
        nomeMes = "fev"; 
        return nomeMes;
    break;
    case '3':
    nomeMes = "mar"; 
        return nomeMes;
    break;
    case '4':
    nomeMes = "abril"; 
        return nomeMes;
    break;
    case '5':
    nomeMes = "maio"; 
        return nomeMes;
    break;
    case '6':
    nomeMes = "jun"; 
        return nomeMes;
    break;
    
}

}
        var nomeMes = datas();
        var biscu = [];
        var tbody = document.getElementById('tbody');
        function AddItemTb(titulo, valor){          
            let trow = document.createElement('tr');
            let td1 = document.createElement('td');
            let td2 = document.createElement('td');
            biscu.push([titulo, valor]);              
        }

        var ID = 0;
        var tbody = document.getElementById("tbody");

        function addItemTd(arraylabels, arraydata){
            let trow = document.createElement('tr');
            let td1 = document.createElement('td');
            let td2 = document.createElement('td');         

                    td1.innerHTML=arraylabels[ID];
                    td2.innerHTML=arraydata[ID];
                    ID++;

            trow.appendChild(td1);
            trow.appendChild(td2);

            tbody.appendChild(trow);
        }        

 function random_rgb() {
            var o = Math.round, r = Math.random, s = 255;
            return "rgb(" + o(r()*s) + ", " + o(r()*s) + ", " + o(r()*s) + ")";
        }

        var doughnut_chart = document.getElementsByClassName("doughnut-chart");
        var DoughnutChart = new Chart(doughnut_chart, {
            type: "doughnut",
            data: [{}],
        });
        
        var line_chart = document.getElementsByClassName("line-chart");
        var LineChart = new Chart(line_chart, {
            type: "line",
            data: createLineChartData(),
            options: {
                responsive: true,
                plugins: {
                    zoom: {
                        pan: {
                            enabled: true,
                            mode: 'xy'
                        },
                        zoom: {
                            wheel: {
                                enabled: true
                            },
                            pinch: {
                                enabled: true
                            },
                            mode: 'xy',
                        },
                    }
                }
            }
        });

        var bar_chart = document.getElementsByClassName("bar-chart");
        var BarChart = new Chart(bar_chart , {
            type: 'bar',
            data: createBarChartData(),
        });

        function createLineChartData(){
            var meses = ["jan", "fev", "mar", "abril", "maio", "jun"];
            var balancos = []; 
            for (var i = 0; i<meses.length; i++){
                const dbRef = ref(db, "users/"+user_final+"/"+meses[i]+"/balancoMensal/");
                onValue(dbRef,(snapshot)=>{                                          
                    snapshot.forEach(childSnapshot =>{
                    balancos.push(childSnapshot.val());                 
                });
                });                                   
            }     

            var data = {
                labels: ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"],
                datasets: [{
                    label: "Balanços Mensais",
                    data: balancos,
                    fill: true,
                    borderColor: 'rgb(245, 193, 22)'
                }], 
            };
            return data;            
        }      

        var selectBoxBar;
        window.getSelectBoxBarValue = function(){
            selectBoxBar = document.getElementById('selectBoxBar').value;
            return selectBoxBar;
            console.log(selectBoxBar);
        }      

            function createBarChartData(){   
                var gastos = [];
                var arrayValor = [];
                var arrayTitulo = [];
                const dbRef = ref(db, "users/"+user_final+"/"+nomeMes+"/gastos/");
                onValue(dbRef,(snapshot)=>{    
                    snapshot.forEach(childSnapshot =>{
                        gastos.push(childSnapshot.val());
                    });                
                    gastos.forEach(element => {
                        if(element.tipo != getSelectBoxBarValue()){
                            return;
                        }else{
                        var valor = parseInt(element.valor);
                        var titulo = element.titulo;
                        arrayValor.push(valor);
                        arrayTitulo.push(titulo);
                        }                                    
                    });
                });
                var data = {
                    labels: arrayTitulo,
                    datasets: [
                    {
                        label: "Teste",
                        data: arrayValor,
                        backgroundColor: ["#ccf6ec", "#ff6654", "#009784", "#009784", "#009784"],
                        hoverBackgroundColor: ["#ccf6ec", "#ff6654", "#009784", "#009784", "#009784"]
                    }]
                }
                return data;
                BarChart.update();
            }  
        

        DoughnutChart.config.data;

        LineChart.config.data = createLineChartData();
        setTimeout(function() { LineChart.update(); },800);
        window.lineResetZoom = function() {
            LineChart.resetZoom();
        }

        BarChart.config.data = createBarChartData();
        setTimeout(function() { BarChart.update(); },800);  
        document.getElementById("selectBoxBar").addEventListener("change", getSelectBoxBarValue()); 

        </script>
        <script>
            
        function teste(elememnto){
            console.log(elemento.value);
        }
        </script>
 
</html>