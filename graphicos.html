<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Gráficos</title>
        <link rel="stylesheet" href="CSS/main2.css">
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
        <script src="autenticar.js"></script>
        <sscript src="logout.js"></sscript>
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
        <link rel="stylesheet" href="https://fonts.sandbox.google.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
     
    </head>
    <style>
        .chart-wrapper{
            height: 70%;
            width: 70%;
            padding-top: 3%;
        }

        .line-bar-chart-wrapper{
            display: flex;
        }

        .line-bar-chart-wrapper .line-chart {
            height: 30%;
            width: 40%;
            margin-right: 2%;
            border-radius: 2%;
        }

        .line-bar-chart-wrapper .bar-chart {
            height: 40%;
            width: 40%;
            margin-left: 2%;
            border-radius: 2%;
        }

        .doughnut-chart-wrapper {            
            display: flex;
        }

        .doughnut-chart1 {
            background-color: white;
            margin-top: 15%;
            border-radius: 2%;
            height: 95%;
            width: 95%;
            margin-right: 2%;
            margin-left: 2%;
        }

        .doughnut-chart2 {
            background-color: white;
            margin-top: 15%;
            border-radius: 2%;
            height: 95%;
            width: 95%;
            margin-left: 2%;
            margin-right: 2%;
        }

    </style>
    <body>
        <div class="corpo" style="background: black;margin-bottom: -90px;">

            
            
            <div class="inner body" style="min-width: 500px;">
                <nav id="more">
                    
                
                <span id="pontin" class="material-symbols-outlined" style="opacity: 0; font-size: 32px;">menu</span>
                
             
                <img src="img/vex dourado.png" width="40px" height="40px" id="iconvex"><span id="closy" class="material-symbols-outlined">close</span>
                <h1 style="color: white; position: relative; bottom: 9%; left: 5%;" id="meter">Vex</h1>
                

                <ul id="links">
                    <a href="metas.html"><li id="metaspc"><p id="metas"><span class="material-symbols-outlined" id="icmetas">add_task</span>Metas</p></li></a>
                    <li id="gestaopc"><a href="index.html"><p id="gestao"><span class="material-symbols-outlined" id="icgestao">inventory</span>Gestão</p></a></li>
                    <li id="controlepc"><a href="main2.html"><p id="controle"><span class="material-symbols-outlined" id="iccontrole">touch_app</span>Controle</p></a></li>
                    <li id="graphicpc"><a href="graphicos.html"><p id="graphic"><span class="material-symbols-outlined" id="icgraphic">monitoring</span>Gráficos</p></a></li>
                </ul>

                                <br>
                
                <p style="text-align:center; color: #f5c116;" id="liniy">_________________________</p>
                
                                <br>

                <button id="logoff" onclick="logout();" style="background-color: transparent; border:none;"><span class="material-symbols-outlined" id="iclogout">logout</span><p style="display: inline-table; text-align: center;" id="sairir">Sair</p></button></div><br><br>

                
                

               <!-- <img id="icon" src="vex dourado.png" style="padding-top: 5%;">-->
                </nav>

                
                

            </div>
            
            <div class="sc-hKgJUU frdCTY">
                <div class="sc-jrAFXE eqoOME" style="flex-direction: column; flex-wrap: wrap; align-content: stretch; justify-content: space-evenly; align-items: stretch;">
                    <div class="sc-kEjbQP fuVdYh">
                        <div class="sc-iqHYmW jklSBJ setleft" id="anterior"><span class="material-symbols-outlined unselectable">
                            arrow_forward_ios
                            </span></div>
                        <div class="sc-crrszt cPfwyB" id="mes">Abril de 2022</div>
                        <div class="sc-iqHYmW jklSBJ setright" id="proximo"><span class="material-symbols-outlined unselectable">
                            arrow_back_ios
                            </span></div>
                    </div>
                    
                </div>
        <div class="chart-wrapper">
            <div class="line-bar-chart-wrapper">
                    <canvas class="line-chart" style="background-color: white;"></canvas>                    
                    <canvas class="bar-chart" style="background-color: white;"></canvas>      
                    <select class="selectBox" id="selectBoxBar" name="selectBoxBar" style="height: 25px;">
                        <option value="Alimentação">Alimentação</option>
                        <option value="Entretenimento">Entretenimento</option>
                        <option value="Habitação">Habitação</option>
                        <option value="Salário">Salário</option>
                        <option value="Saúde">Saúde</option>
                        <option value="Seguros">Seguros</option>
                        <option value="Transportes">Transportes</option>                
                        <option value="Outros">Outros</option>                        
                    </select>      
                </div>
                <button onclick="lineResetZoom()">Reset</button>
                <div class="doughnut-chart-wrapper">
                    <canvas class="doughnut-chart1"></canvas>
                    <canvas class="doughnut-chart2"></canvas>
                </div>
            <br>
        
        </div>
        <section class="chart-tables" style="display: none;">
            <table class="crud chart-tables" >
                <thead>
                    <tr>
                        <th>Titulo</th>
                        <th>Valor</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>
        </section>
        <div id="guardaOmes" style="color: white; display: none;" ></div>
    </body>
        <script src="node_modules/chart.js/dist/chart.min.js"></script>
        <script src="node_modules/chart.js/dist/chart.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
        <script src="node_modules/chartjs-plugin-zoom/dist/chartjs-plugin-zoom.min.js"></script>
        <script src="node_modules/chartjs-plugin-zoom/dist/chartjs-plugin-zoom.js"></script>
        <script type="module">
            const usuario = "teste";
            var user_final = localStorage.getItem('valueText');
            
            // Import the functions you need from the SDKs you need
            import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.8/firebase-app.js";
            import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.6.8/firebase-analytics.js";
    
            // TODO: Add SDKs for Firebase products that you want to use
            // https://firebase.google.com/docs/web/setup#available-libraries
          
            // Your web app's Firebase configuration
            // For Firebase JS SDK v7.20.0 and later, measurementId is optional
            const firebaseConfig = {
              apiKey: "AIzaSyCd8BHepAbgzsZF0Ig8NRgsnTPRKvYkO4g",
              authDomain: "vexv1-adc55.firebaseapp.com",
              databaseURL: "https://vexv1-adc55-default-rtdb.firebaseio.com",
              projectId: "vexv1-adc55",
              storageBucket: "vexv1-adc55.appspot.com",
              messagingSenderId: "827882444760",
              appId: "1:827882444760:web:3b65498f6fe2161d1244ad",
              measurementId: "G-FBJX3WSQDX"
            };

   
    
             const firebaseApp = initializeApp(firebaseConfig);
          
            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const analytics = getAnalytics(app);
            import{getDatabase, ref, get, set, child, update, remove, onValue}
            from "https://www.gstatic.com/firebasejs/9.6.8/firebase-database.js";
            const db = getDatabase();
        
            function autenticar(){
            const dbref = ref(db);
get(child(dbref,"users/"+user_final)).then((snapshot)=>{

                var nome = snapshot.val().fullname;
                var senha = snapshot.val().password;
                if ((localStorage.getItem('nome') == nome) && (localStorage.getItem('senha') == senha))
                {   
                }
                else
                {

                    window.location.href = 'index.html';
                } 
                
                
        }).catch((error)=>{
            window.location.href = 'index.html';
        });
        }
        window.onload = autenticar;
        

//------------------------------DECLARANDO VÁRIAVEIS GLOBAIS------------------------------//
var btn_adicionar = document.getElementById("adicionar");

function mesAnterior(){
    var mes = parseInt(document.getElementById('guardaOmes').textContent);
    mes = mes-1;
    mes = parseInt(mes);
    if(mes<1){ mes = 12}
    document.getElementById('guardaOmes').textContent = mes;

    BarChart.config.data = createBarChartData();
    setTimeout(function() { BarChart.update(); },800);
    DoughnutChart1.config.data = createDoughnutChartData("Receita");
    setTimeout(function() {  DoughnutChart1.update(); },800);
    DoughnutChart2.config.data = createDoughnutChartData("Despesa");
    setTimeout(function() {  DoughnutChart2.update(); },800);
    datas(mes);
}
function mesPosterior(){
    var mes = parseInt(document.getElementById('guardaOmes').textContent);
    mes = mes+1;
    mes = parseInt(mes);
    if(mes>12){ mes = 1}
    document.getElementById('guardaOmes').textContent = mes;

    BarChart.config.data = createBarChartData();
    setTimeout(function() { BarChart.update(); },800);
    DoughnutChart1.config.data = createDoughnutChartData("Receita");
    setTimeout(function() {  DoughnutChart1.update(); },800);
    DoughnutChart2.config.data = createDoughnutChartData("Despesa");
    setTimeout(function() {  DoughnutChart2.update(); },800);

    datas(mes);
}



function datas(mes){

   
    if(mes == undefined){
    var data = new Date()
var mes = String(data.getMonth() + 1);
document.getElementById('guardaOmes').textContent = `${mes}`;
}
mes = document.getElementById('guardaOmes').textContent
switch(mes){
    case '1':
        nomeMes = "jan";
        document.getElementById('mes').textContent = "Janeiro de 2022";
  

    return nomeMes;

    break;
    case '2':
    nomeMes = "fev"; 
    document.getElementById('mes').textContent = "Fevereiro de 2022";

    return nomeMes;

    break;
    case '3':
    nomeMes = "mar"; 
    document.getElementById('mes').textContent = "Março de 2022";

        return nomeMes;
    break;
    case '4':
    nomeMes = "abril"; 
    document.getElementById('mes').textContent = "Abril de 2022";

        return nomeMes;
    break;
    case '5':
    nomeMes = "maio"; 
    document.getElementById('mes').textContent = "Maio de 2022";

        return nomeMes;
    break;
    case '6':
    nomeMes = "jun"; 
    document.getElementById('mes').textContent = "Junho de 2022";

        
    return nomeMes;
    break;
    case '7':
    nomeMes = "jul"; 
    document.getElementById('mes').textContent = "Julho de 2022";

       
    return nomeMes;
    break;
    case '8':
    nomeMes = "ago"; 
    document.getElementById('mes').textContent = "Agosto de 2022";

 
    return nomeMes;
    break;

        case '9':
    nomeMes = "set"; 
    document.getElementById('mes').textContent = "Setembro de 2022";


    return nomeMes;
    break;

        case '10':
    nomeMes = "out"; 
    document.getElementById('mes').textContent = "Outubro de 2022";

    
    return nomeMes;
    break;

        case '11':
    nomeMes = "nov"; 
    document.getElementById('mes').textContent = "Novembro de 2022";

    
    return nomeMes;
    break;

        case '12':
    nomeMes = "dez"; 
    document.getElementById('mes').textContent = "Dezembro de 2022";

        return nomeMes;
    break;
    
}
}




        var nomeMes = datas();
        document.getElementById('anterior').addEventListener('click', mesAnterior);
    document.getElementById('proximo').addEventListener('click', mesPosterior);
        var biscu = [];
        var tbody = document.getElementById('tbody');
        function AddItemTb(titulo, valor){          
            let trow = document.createElement('tr');
            let td1 = document.createElement('td');
            let td2 = document.createElement('td');
            biscu.push([titulo, valor]);              
        }

        var ID = 0;
        var tbody = document.getElementById("tbody");

        function addItemTd(arraylabels, arraydata){
            let trow = document.createElement('tr');
            let td1 = document.createElement('td');
            let td2 = document.createElement('td');         

                    td1.innerHTML=arraylabels[ID];
                    td2.innerHTML=arraydata[ID];
                    ID++;

            trow.appendChild(td1);
            trow.appendChild(td2);

            tbody.appendChild(trow);
        }        

 function random_rgb() {
            var o = Math.round, r = Math.random, s = 255;
            return "rgb(" + o(r()*s) + ", " + o(r()*s) + ", " + o(r()*s) + ")";
        }

        var doughnut_chart1 = document.getElementsByClassName("doughnut-chart1");
        var DoughnutChart1 = new Chart(doughnut_chart1, {
            type: "doughnut",
            data: createDoughnutChartData("Receita"),
        });

        var doughnut_chart2 = document.getElementsByClassName("doughnut-chart2");
        var DoughnutChart2 = new Chart(doughnut_chart2, {
            type: "doughnut",
            data: createDoughnutChartData("Despesa"),
        });
        
        var line_chart = document.getElementsByClassName("line-chart");
        var LineChart = new Chart(line_chart, {
            type: "line",
            data: createLineChartData(),
            options: {
                responsive: true,
                plugins: {
                    zoom: {
                        pan: {
                            enabled: true,
                            mode: 'xy'
                        },
                        zoom: {
                            wheel: {
                                enabled: true
                            },
                            pinch: {
                                enabled: true
                            },
                            mode: 'xy',
                        },
                    }
                }
            }
        });

        var bar_chart = document.getElementsByClassName("bar-chart");
        var BarChart = new Chart(bar_chart , {
            type: 'bar',
            data: createBarChartData(),
            options: {
                scales: {
                    yAxes: {
                        display: true,
                        ticks: {
                            beginAtZero: true,
                            steps: 10,
                            stepValue: 5,
                            max: 100
                        }
                    },
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });

        function createLineChartData(){
            var meses = ["jan", "fev", "mar", "abril", "maio", "jun"];
            var balancos = []; 
            var ganhos = [];
            var despesas = [];
            for (var i = 0; i<meses.length; i++){
                const dbRef = ref(db, "users/"+user_final+"/"+meses[i]+"/balancoMensal/");
                onValue(dbRef,(snapshot)=>{                                          
                    snapshot.forEach(childSnapshot =>{
                    balancos.push(childSnapshot.val());                 
                    });
                });                                   
            }
            for (var i = 0; i<meses.length; i++){
                const dbRef = ref(db, "users/"+user_final+"/"+meses[i]+"/ganhoMensal/");
                onValue(dbRef,(snapshot)=>{                                          
                    snapshot.forEach(childSnapshot =>{
                    ganhos.push(childSnapshot.val());                 
                    });
                });                                   
            }
            for (var i = 0; i<meses.length; i++){
                const dbRef = ref(db, "users/"+user_final+"/"+meses[i]+"/despesaMensal/");
                onValue(dbRef,(snapshot)=>{                                          
                    snapshot.forEach(childSnapshot =>{
                    despesas.push(childSnapshot.val());                 
                    });
                });                                   
            }        

            var data = {
                labels: ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"],
                datasets: [{
                    label: "Balanços Mensais",
                    data: balancos,
                    borderColor: 'rgb(245, 193, 22)',
                    tension: 0.2
                },
                {
                    label: "Ganhos Mensais",
                    data: ganhos,
                    borderColor: 'rgb(10, 233, 10)',
                    tension: 0.2,
                },
                {
                    label: "Despesas Mensais",
                    data: despesas,
                    borderColor: 'rgb(255, 0, 0',
                    tension: 0.2
                }], 
            };
            return data;            
        }      

        var selectBoxBar;
        window.getSelectBoxBarValue = function(){
            selectBoxBar = document.getElementById('selectBoxBar').value;
            return selectBoxBar;
        }      

        function createBarChartData(){   
            var num = document.getElementById('guardaOmes').textContent;
            var nomeMes = datas(num);
            var gastos = [];
            var arrayValor = [];
            var arrayTitulo = [];
            const dbRef = ref(db, "users/"+user_final+"/"+nomeMes+"/gastos/");
            onValue(dbRef,(snapshot)=>{    
                snapshot.forEach(childSnapshot =>{
                    gastos.push(childSnapshot.val());
                });                
                gastos.forEach(element => {
                    if(element.tipo != getSelectBoxBarValue()){
                        return;
                    }else{
                    var valor = parseInt(element.valor);
                    var titulo = element.titulo;
                    arrayValor.push(valor);
                    arrayTitulo.push(titulo);
                    }                                    
                });
            });

            var data = {
                labels: arrayTitulo,
                datasets: [{
                    data: arrayValor,
                    backgroundColor: ["#ccf6ec", "#ff6654", "#009784", "#009784", "#009784"],
                }]
                    
            }
            console.log("Função do BarChart foi")
                return data;
        }  

        function createDoughnutChartData(tipo){
            var num = document.getElementById('guardaOmes').textContent;
            var nomeMes = datas(num);
            var gastos = [];
            var arrayValores = [0, 0, 0, 0, 0, 0, 0, 0];
            var arrayTipos = ["Alimentação", "Entretenimento", "Habitação", "Salário", "Saúde", "Seguros", "Transportes", "Outros"];
            const dbRef = ref(db, "users/"+user_final+"/"+nomeMes+"/gastos/");
            onValue(dbRef,(snapshot)=>{    
                snapshot.forEach(childSnapshot =>{
                    gastos.push(childSnapshot.val());
                });
                gastos.forEach(element => {
                    if(element.transferencia != tipo){
                        for(var i = 0; i<=arrayValores.length; i++){
                            if (element.tipo == arrayTipos[i]){
                                arrayValores[i] = arrayValores[i] + parseFloat(element.valor);
                            }
                        }
                    }
                }); 
            });
           
            var data = {
                labels: arrayTipos,
                datasets: [{
                    label: "Teste",
                    data: arrayValores,
                    backgroundColor: ["#ff4b2b", "#db2d1f", "#8dd34e", "#31830e", "#2cc5f4", "#1675af", "#8e6eb7", "#69419d"],
                    hoverOffset: 7
                }]     
            }
            console.log("Função do DoughnutChart foi")
                return data;
        }

        DoughnutChart1.config.data = createDoughnutChartData("Receita");
        setTimeout(function() {  DoughnutChart1.update(); },800);

        DoughnutChart2.config.data = createDoughnutChartData("Despesa");
        setTimeout(function() {  DoughnutChart2.update(); },800);


        LineChart.config.data = createLineChartData();
        setTimeout(function() { LineChart.update(); },800);
        window.lineResetZoom = function() {
            LineChart.resetZoom();
        }

        BarChart.config.data = createBarChartData();
        setTimeout(function() { BarChart.update(); },800); 
        
        const selectElement = document.querySelector('#selectBoxBar');
        selectElement.addEventListener('change', (event) => {
            getSelectBoxBarValue();
            BarChart.config.data = createBarChartData();
            BarChart.update();
        });

    </script>
                          <script src="menu.js"></script>
</html>